#!/usr/bin/env bash
set -e
__version=@PROJECT_VERSION@
which mpv youtube-dl > /dev/null

source `dirname ${BASH_SOURCE[0]}`/../lib/extractors.sh

usage()
{
    cat <<EOF
Usage: $0 [-e <name>|-u|-y] [-b] <url>|-h|-v|-l
    <url> --- your url to play
    -e <name> --- use <name> extractor
    -u --- only show extracted url, don't play it
    -h --- print this help & exit
    -v --- print version & exit
    -l --- list known extractors & exit
    -b --- detach mpv to separate session

EOF
}

while getopts "vhe:lub" opt; do
    case "$opt" in
        v) echo Version: $__version; exit 0;;
        l) echo "Known extractors:"; printf "* %s\n" "${extractors[@]}"; exit 0;;
        e) __extractor="$OPTARG";;
        u) __only_url=1;;
        h) usage; exit 0;;
        b) __background=1;;
    esac
done
shift $((OPTIND - 1))

if [[ ! -z "$__extractor" ]]; then
    __url=`$__extractor "$1"`
else
    for ex in ${extractors[@]}; do
        __url=`$ex "$1"` || continue
        break
    done
fi

if [[ -z "$__only_url" ]]; then
    if [[ -z "$__background" ]]; then
        mpv "$__url"
    else
        (set -m; exec mpv "$__url" &>/dev/null &)
    fi
else
    echo $__url
fi
